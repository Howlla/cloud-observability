#cloud-config

runcmd:
  - apt-get update
  - hostname control-node-1
  - hostnamectl set-hostname control-node-1
  - swapoff -a
  - |
    cat <<EOF | tee /etc/modules-load.d/k8s.conf
    overlay
    br_netfilter
    EOF
  - modprobe overlay
  - modprobe br_netfilter
  - |
    cat <<EOF | tee /etc/sysctl.d/k8s.conf
    net.bridge.bridge-nf-call-iptables  = 1
    net.bridge.bridge-nf-call-ip6tables = 1
    net.ipv4.ip_forward                 = 1
    EOF
  - sysctl --system
  - apt-get install -y containerd
  - wget https://github.com/containerd/containerd/releases/download/v1.6.12/containerd-1.6.12-linux-amd64.tar.gz
  - tar xvf containerd-1.6.12-linux-amd64.tar.gz
  - systemctl stop containerd
  - cd bin
  - cp * /usr/bin/
  - systemctl start containerd
  - mkdir -p /etc/containerd
  - containerd config default | tee /etc/containerd/config.toml
  - sed -i 's/            SystemdCgroup = false/            SystemdCgroup = true/' /etc/containerd/config.toml
  - systemctl restart containerd
  - curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
  - |
    echo "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main" | tee /etc/apt/sources.list.d/kubernetes.list
  - apt-get update
  - apt-cache policy kubelet | head -n 20
  - VERSION=1.25.6-00
  - apt-get install -y kubelet=$VERSION kubeadm=$VERSION kubectl=$VERSION
  - apt-mark hold kubelet kubeadm kubectl containerd
  - systemctl enable kubelet.service
  - systemctl enable containerd.service
  - cd
  - kubeadm init --kubernetes-version v1.25.6
  - mkdir -p $HOME/.kube
  - cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  - chown $(id -u):$(id -g) $HOME/.kube/config
  - wget https://raw.githubusercontent.com/projectcalico/calico/v3.25.0/manifests/calico.yaml
  - kubectl apply -f calico.yaml
  - curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
  - chmod 700 get_helm.sh
  - ./get_helm.sh